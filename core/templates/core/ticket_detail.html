{% extends 'core/base.html' %}
{% load static %}

{% block title %}Заявка #{{ ticket.id }} | TechCare{% endblock %}

{% block content %}
<div class="container py-4">

    <a href="{% if user.is_staff %}{% url 'dashboard_staff' %}{% else %}{% url 'dashboard_user' %}{% endif %}" class="back-link-top">
        <i class="bi bi-arrow-left"></i> Назад до списку
    </a>

    <div class="ticket-meta">
        Заявка #{{ ticket.id }} • Створено {{ ticket.created_at|timesince }} тому
    </div>
    <h1 class="ticket-title">{{ ticket.title }}</h1>

    <div class="row">
        <div class="col-lg-8">
            
            <div class="comment-card">
                <div class="comment-header">
                    <div>
                        <span class="comment-author">{{ ticket.created_by.first_name|default:ticket.created_by.username }}</span>
                        </div>
                    <span class="comment-date">{{ ticket.created_at|date:"d.m.Y, H:i" }}</span>
                </div>
                <div class="comment-text">
                    {{ ticket.description|linebreaks }}
                </div>
            </div>

            {% for comment in comments %}
                {% if not comment.is_internal or user.is_staff %}
                    <div class="comment-card {% if comment.author.is_staff %}staff-reply{% endif %}" 
                         style="{% if comment.is_internal %}border: 1px dashed #ffc107;{% endif %}">
                        
                        <div class="comment-header">
                            <div>
                                <span class="comment-author">{{ comment.author.first_name|default:comment.author.username }}</span>
                                {% if comment.author.is_staff %}
                                    <span class="comment-role">Фахівець</span>
                                {% endif %}
                                {% if comment.is_internal %}
                                    <span class="badge bg-warning text-dark ms-2">Приватна нотатка</span>
                                {% endif %}
                            </div>
                            <span class="comment-date">{{ comment.created_at|date:"d.m.Y, H:i" }}</span>
                        </div>
                        <div class="comment-text">
                            {{ comment.text|linebreaks }}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}

            <div class="reply-area mt-4">
                <form method="POST">
                    {% csrf_token %}
                    <textarea name="text" class="reply-textarea" rows="4" placeholder="Напишіть відповідь або внутрішню нотатку..." required></textarea>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if user.is_staff %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_internal" id="internalCheck">
                                <label class="form-check-label text-muted" for="internalCheck" style="font-size: 13px;">
                                    Тільки для фахівця (Приватна нотатка)
                                </label>
                            </div>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn-gradient px-4 py-2" style="font-size: 14px;">
                            Відправити
                        </button>
                    </div>
                </form>
            </div>

        </div>

        <div class="col-lg-4">
            
            <div class="sidebar-card">
                <h5 class="text-white mb-3" style="font-size: 14px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;">Деталі</h5>
                
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="update_status" value="true">

                    <div class="mb-3">
                        <label class="sidebar-label">Статус</label>
                        {% if user.is_staff %}
                            <select name="status" class="form-select-custom py-2" style="font-size: 14px;" onchange="this.form.submit()">
                                {% for val, label in ticket.STATUS_CHOICES %}
                                    <option value="{{ val }}" {% if ticket.status == val %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <div class="form-control-custom" style="padding: 10px;">{{ ticket.get_status_display }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="sidebar-label">Пріоритет</label>
                        {% if user.is_staff %}
                            <select name="priority" class="form-select-custom py-2" style="font-size: 14px;" onchange="this.form.submit()">
                                {% for val, label in ticket.PRIORITY_CHOICES %}
                                    <option value="{{ val }}" {% if ticket.priority == val %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                             <div class="form-control-custom" style="padding: 10px;">{{ ticket.get_priority_display }}</div>
                        {% endif %}
                    </div>
                </form>

                {% if user.is_staff %}
                    {% if not ticket.assigned_to %}
                        <form method="POST">
                            {% csrf_token %}
                            <button type="submit" name="assign_me" class="btn-assign">
                                Забронювати заявку
                            </button>
                        </form>
                    {% else %}
                        <div class="mt-3 text-center">
                            <span class="text-muted" style="font-size: 12px;">Виконавець:</span><br>
                            <span class="text-white fw-bold">{{ ticket.assigned_to.first_name }}</span>
                        </div>
                    {% endif %}
                {% endif %}
            </div>

            <div class="sidebar-card">
                <h5 class="text-white mb-3" style="font-size: 14px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;">Пов'язане обладнання</h5>
                
                <div class="equipment-mini-card">
                    <i class="bi bi-laptop equip-icon"></i>
                    <div class="equip-info">
                        {% if ticket.equipment %}
                            <h6>{{ ticket.equipment }}</h6>
                            <span>Інв. номер: Не вказано</span>
                        {% else %}
                            <span class="text-muted">Обладнання не додано</span>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}